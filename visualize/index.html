<!DOCTYPE html>
<html>
<head>
    <title>Console</title>
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.0/cosmo/bootstrap.min.css" />
    <style type="text/css">
        html, body, .fullpage {
            height: 100%;
            overflow: auto;
        }
        #welcome {
            margin: 0 auto;
            width: 100%;
            max-width: 960px;
        }
        #canvas {
            display: none;
            position: relative;
            z-index: 1;
        }
        #file-list, #code-preview-row {
            display: none;
        }
    </style>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.min.js"></script>
</head>
<script type="text/javascript">
    const setTc = (el, content) => el.replaceChild(document.createTextNode(content), el.firstChild);

    const setUpAnimOptions = () => {
        const el$exaggerate = document.getElementById('animopt-exaggerate');
        const el$speed = document.getElementById('animopt-speed');
        const el$showpoints = document.getElementById('animopt-showpoints');
        const el$screenshotIndicator = document.getElementById('animopt-screenshot-indicator');
        const el$screenshot = document.getElementById('animopt-screenshot-interval');
        const map = input => Math.round(Math.exp(input.value * Math.log(100)) * 1000) / 1000;
        [el$exaggerate, el$speed].forEach(input => input.addEventListener('input', () =>
            setTc(input.parentNode.nextElementSibling, map(input))
        ));
        el$screenshot.addEventListener('input', () => {
            const val = parseFloat(el$screenshot.value);
            if (isNaN(val) || (val <= 0)) {
                setTc(el$screenshotIndicator, 'off');
                el$screenshotIndicator.className = 'badge badge-light';
            } else {
                setTc(el$screenshotIndicator, 'on');
                el$screenshotIndicator.className = 'badge badge-primary';
            }
        });
        return () => ({
            exaggerateY: map(el$exaggerate),
            speed: map(el$speed),
            showNodes: el$showpoints.checked,
            screenshotEvery: Math.max(parseFloat(el$screenshot.value) || 0, 0)
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        const el$welcome = document.getElementById('welcome');
        const el$display = document.getElementById('display');
        const el$title = document.getElementById('title');
        const el$canvas = document.getElementById('canvas');
        const el$codePreviewRow = document.getElementById('code-preview-row');
        const el$codePreview = document.getElementById('code-preview');
        const el$fileName = document.getElementById('file-name');
        const animOptions = setUpAnimOptions();

        let currentId = null;
        const saveScreenshot = time => new Promise((res, rej) =>
            el$canvas.toBlob(blob => {
                const fd = new FormData();
                fd.append('id', currentId);
                fd.append('time', time.toFixed(3));
                fd.append('image', blob);
                fetch('/save', {
                    method: 'POST',
                    body: fd
                }).then(response => response.text()).then(res).catch(rej);
            })
        );

        const render = ({ meta, frames }, options) => {
            const destWidth = el$canvas.parentNode.clientWidth;
            const destHeight = el$canvas.parentNode.clientHeight - el$canvas.previousElementSibling.clientHeight;
            el$canvas.width = destWidth;
            el$canvas.height = destHeight;
            el$canvas.style.display = 'block';

            let minX = Number.MAX_VALUE;
            let maxX = Number.MIN_VALUE;
            let minY = Number.MAX_VALUE;
            let maxY = Number.MIN_VALUE;

            frames.forEach(row => row.points.forEach(entry => {
                if (entry.x > maxX) { maxX = entry.x; }
                if (entry.x < minX) { minX = entry.x; }
                if (entry.y > maxY) { maxY = entry.y; }
                if (entry.y < minY) { minY = entry.y; }
            }));
            const path = new THREE.CatmullRomCurve3(frames[0].points, meta.closed);
            const sections = frames[0].points.length - (meta.closed ? 0 : 1);

            const geometry = new THREE.TubeBufferGeometry(path, sections, meta.radius, options.showNodes ? 16 : 32, meta.closed);

            const material = new THREE.MeshLambertMaterial({
                color: 0x2962FF,
                wireframe: options.showNodes
            });

            const scene = new THREE.Scene();
            scene.add(new THREE.Mesh(geometry, material));
            scene.add(new THREE.AmbientLight(0xffffff, 1));
            scene.add(new THREE.DirectionalLight(0xffff00, 2));
            // const thirdLight = new THREE.PointLight(0xffff00, 1);
            // thirdLight.position.set((minX + maxX) / 2, maxY + (maxY - minY) * 0.25, 0);
            // thirdLight.lookAt((minX + maxX) / 2, minY, 0);
            // scene.add(thirdLight);

            const dotGeometry = options.showNodes ? new THREE.Geometry() : null;
            if (options.showNodes) {
                frames[0].points.forEach(entry =>
                    dotGeometry.vertices.push(new THREE.Vector3(entry.x, entry.y, 0))
                );
                const dotMaterial = new THREE.PointsMaterial({ size: 4, sizeAttenuation: false, color: 0xffffff });
                scene.add(new THREE.Points(dotGeometry, dotMaterial));
            }

            if (meta.ground) {
                const texture = new THREE.TextureLoader().load('static/book.jpg');
                texture.anisotropy = 32;
                const imageMaterial = new THREE.MeshBasicMaterial({ map: texture });
                const gndGeometry = new THREE.PlaneGeometry((maxX - minX) * 1.5, (maxX - minX) * 1.5 * 1373 / 2082);
                const gndPlane = new THREE.Mesh(gndGeometry, imageMaterial);
                gndPlane.position.set((minX + maxX) / 2, - meta.radius, 0);
                gndPlane.lookAt(new THREE.Vector3((minX + maxX) / 2, 1, 0));
                scene.add(gndPlane);
            }

            const cameraZ4Y = (maxY - minY + 4 * meta.radius) / 1.75 / Math.tan(Math.PI * 45 / 360); // https://stackoverflow.com/a/23361117/2098471
            const cameraZ4X = ((maxX - minX + 4 * meta.radius) * destHeight / destWidth) / 1.75 / Math.tan(Math.PI * 45 / 360);
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, Math.max(cameraZ4X, cameraZ4Y) / 4, 500);
            camera.position.set((minX + maxX) / 2, (minY + maxY) / 2, Math.max(cameraZ4X, cameraZ4Y));
            camera.lookAt(new THREE.Vector3((minX + maxX) / 2, (minY + maxY) / 2, 0));

            const renderer = new THREE.WebGLRenderer({ canvas: el$canvas });
            renderer.render(scene, camera);

            let startTime = null;
            let fIndexHigh = 1;
            const doAnimation = secondsElapsed => {
                let shouldRequestNextFrame = true;
                while (frames[fIndexHigh].time < secondsElapsed) {
                    if (fIndexHigh === frames.length - 1) {
                        // final state reached
                        secondsElapsed = frames[fIndexHigh].time;
                        shouldRequestNextFrame = false;
                        break;
                    }
                    fIndexHigh++;
                }
                const fIndexLow = fIndexHigh - 1;
                const frameIndex = (secondsElapsed - frames[fIndexLow].time) / (frames[fIndexHigh].time - frames[fIndexLow].time) + fIndexLow;
                const nodes = frames[fIndexHigh].points.map((fhp, vindex) => {
                    return new THREE.Vector3(
                        fhp.x * (frameIndex - fIndexLow) + frames[fIndexLow].points[vindex].x * (fIndexHigh - frameIndex),
                        fhp.y * (frameIndex - fIndexLow) + frames[fIndexLow].points[vindex].y * (fIndexHigh - frameIndex),
                        fhp.z * (frameIndex - fIndexLow) + frames[fIndexLow].points[vindex].z * (fIndexHigh - frameIndex)
                    );
                });
                if (options.showNodes) {
                    nodes.forEach((node, vindex) => {
                        dotGeometry.vertices[vindex].set(node.x, node.y, node.z);
                    });
                    dotGeometry.verticesNeedUpdate = true;
                }
                geometry.copy(new THREE.TubeBufferGeometry(new THREE.CatmullRomCurve3(nodes, meta.closed), sections, meta.radius, options.showNodes ? 16 : 32, meta.closed));
                geometry.needUpdate = true;
                setTc(el$display, 'Animating: t = ' + secondsElapsed.toFixed(3));
                renderer.render(scene, camera);
                return shouldRequestNextFrame;
            };
            const animate = function (time) {
                if (!startTime) {
                    startTime = time;
                    requestAnimationFrame(animate);
                    return;
                }
                let secondsElapsed = (time - startTime) / 1000 * options.speed;
                if (doAnimation(secondsElapsed)) {
                    requestAnimationFrame(animate);
                }
            };
            if (options.screenshotEvery) { // screenshot mode
                let currentTime = 0;
                const step = () => {
                    saveScreenshot(currentTime).then(() => {
                        currentTime += options.screenshotEvery;
                        if (doAnimation(currentTime)) {
                            step();
                        }
                    });
                };
                step();
            } else { // animate mode
                requestAnimationFrame(animate);
            }
        };

        let jsonData = null;

        fetch('/list?at=' + Date.now()).then(response => response.json()).then(dirs => {
            const keys = Object.keys(dirs).sort();
            if (keys.length) {
                let selected = null;
                const fl = document.getElementById('file-list');
                const btn = fl.nextElementSibling;
                setTc(fl.previousElementSibling, 'Select a previous result to load.');
                btn.classList.remove('disabled');
                keys.forEach(dir => {
                    let parent;
                    if (dir) {
                        parent = document.createElement('li');
                        parent.className = 'list-group-item py-2';
                        parent.appendChild(document.createTextNode(dir));
                        fl.appendChild(parent);
                    }
                    const lis = dirs[dir].sort().map(entry => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item pl-5 py-2';
                        li.appendChild(document.createTextNode(entry));
                        li.addEventListener('click', () => {
                            if (selected) { selected.classList.remove('active'); }
                            selected = li;
                            li.classList.add('active');
                            el$codePreviewRow.style.display = 'none';
                            jsonData = fetch('data' + dir + '/' + entry + '?at=' + Date.now()).then(response => response.json());
                            jsonData.then(data => {
                                if (data.code) {
                                    setTc(el$fileName, entry);
                                    setTc(el$codePreview, data.code);
                                    el$codePreviewRow.style.display = 'block';
                                }
                            });
                        });
                        fl.appendChild(li);
                        return li;
                    });
                    if (parent) {
                        lis.forEach(li => li.style.display = 'none');
                        parent.addEventListener('click', () => {
                            const now = parent.classList.contains('text-muted');
                            lis.forEach(now ? (li => li.style.display = 'none') : (li => li.style.display = 'block'));
                            parent.classList[now ? 'remove' : 'add']('text-muted');
                        });
                    }
                });
                fl.style.display = 'block';
                btn.addEventListener('click', () => {
                    if (!selected) {
                        window.alert('Please select a file first!');
                    } else {
                        const title = selected.firstChild.textContent;
                        const options = animOptions();
                        if (options.screenshotEvery) {
                            currentId = title.substr(0, title.length - 4).replace(/[^A-Za-z0-9_]/g, '').substr(0, 4);
                            while (currentId.length < 5) {
                                currentId += String.fromCharCode(Math.random() * 26 + 97);
                            }
                            window.alert('Screenshot will be save with a prefix of ' + currentId);
                        }
                        jsonData.then(data => {
                            data.frames.forEach(frame => {
                                let output = [];
                                for (let i = 0; i < frame.data.length; i += 2) {
                                    output.push(new THREE.Vector3(frame.data[i], frame.data[i + 1] * options.exaggerateY, 0));
                                }
                                frame.points = output;
                                delete frame.data;
                            });
                            setTc(el$title, title);
                            el$welcome.style.display = 'none';
                            render(data, options);
                        });
                    }
                });
            }
        });
    });
</script>
<body>
    <div class="fullpage">
        <nav class="navbar navbar-dark bg-primary">
            <span class="navbar-brand" id="title">MAE 259B / Group 2: DER</span>
            <span class="navbar-text" id="display">Stopped</span>
        </nav>
        <canvas id="canvas"></canvas>
        <div id="welcome" class="mb-5">
            <div class="row px-5">
                <div class="col-sm-6">
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title">Animation Options</h5>
                            <form>
                                <div class="form-group row">
                                    <label for="animopt-exaggerate" class="col-4 col-form-label">Exaggerate Y</label>
                                    <div class="col-6">
                                        <input type="range" class="form-control" id="animopt-exaggerate" min="0" max="1" step="0.001" value="0" />
                                    </div>
                                    <div class="col-2">1</div>
                                </div>
                                <div class="form-group row">
                                    <label for="animopt-speed" class="col-4 col-form-label">Playback speed</label>
                                    <div class="col-6">
                                        <input type="range" class="form-control" id="animopt-speed" min="-0.5" max="0.5" step="0.001" value="0" />
                                    </div>
                                    <div class="col-2">1</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="animopt-showpoints">
                                    <label class="form-check-label" for="animopt-showpoints">Show nodes</label>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title">Screenshot mode <span class="badge badge-pill badge-light" id="animopt-screenshot-indicator">off</span></h5>
                            <p>Screenshot mode is disabled by default. Enter a non-zero number below to turn it on.</p>
                            <div class="form-group row">
                                <label for="animopt-screenshot-interval" class="col-6 col-form-label">Take screenshot every</label>
                                <div class="col-5">
                                    <input type="number" class="form-control" id="animopt-screenshot-interval" value="0" />
                                </div>
                                <label for="animopt-screenshot-interval" class="col-1 col-form-label">s</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title">Load a previous result</h5>
                            <p class="card-text">No saved result available.</p>
                            <ul class="list-group list-group-flush mb-4" id="file-list">
                            </ul>
                            <button class="btn btn-primary disabled">Go</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row px-5" id="code-preview-row">
                <div class="col-12 mt-5">
                    <div class="card">
                        <div class="card-header">
                            Code snapshot for generating <span id="file-name">data file</span>
                        </div>
                        <div class="card-body">
                            <pre id="code-preview">N/A</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>