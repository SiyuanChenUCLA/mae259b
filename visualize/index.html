<!DOCTYPE html>
<html>
<head>
    <title>Console</title>
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.0/cosmo/bootstrap.min.css" />
    <style type="text/css">
        html, body, .fullpage {
            height: 100%;
            overflow: hidden;
        }
        #welcome {
            margin: 0 auto;
            width: 100%;
            max-width: 960px;
        }
        #canvas {
            display: none;
            position: relative;
            z-index: 1;
        }
        #file-list {
            display: none;
        }
    </style>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.min.js"></script>
</head>
<script type="text/javascript">
    const setTc = (el, content) => el.replaceChild(document.createTextNode(content), el.firstChild);

    const Proxy = function (path) {
        THREE.Curve.call(this);
        this.path = path;
    };
    Proxy.prototype = Object.create(THREE.Curve.prototype);
    Proxy.prototype.constructor = Proxy;
    Proxy.prototype.getPoint = function (t) {
        const gpt = this.path.getPoint(t);
        return new THREE.Vector3(gpt.x, gpt.y, 0);
    };

    const setUpAnimOptions = () => {
        const exaggerate = document.getElementById('animopt-exaggerate');
        const speed = document.getElementById('animopt-speed');
        const showpoints = document.getElementById('animopt-showpoints');
        const radius = document.getElementById('animopt-radius');
        const map = input => Math.round(Math.exp(input.value * Math.log(100)) * 1000) / 1000;
        [exaggerate, speed].forEach(input => input.addEventListener('input', () =>
            setTc(input.parentNode.nextElementSibling, map(input))
        ));
        radius.addEventListener('change', () => {
            if (isNaN(parseFloat(radius.value))) {
                radius.value = '5e-3';
            }
        });
        return () => ({
            exaggerateY: map(exaggerate),
            speed: map(speed),
            showNodes: showpoints.checked,
            radius: parseFloat(radius.value)
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        const display = document.getElementById('display');
        const title = document.getElementById('title');
        const canvas = document.getElementById('canvas');
        const animOptions = setUpAnimOptions();

        const render = (data, options) => {
            const destWidth = canvas.parentNode.clientWidth;
            const destHeight = canvas.parentNode.clientHeight - canvas.previousElementSibling.clientHeight;
            canvas.width = destWidth;
            canvas.height = destHeight;
            canvas.style.display = 'block';

            let minX = Number.MAX_VALUE;
            let maxX = Number.MIN_VALUE;
            let minY = Number.MAX_VALUE;
            let maxY = Number.MIN_VALUE;

            data[0].points.forEach(entry => {
                if (entry.x > maxX) { maxX = entry.x; }
                if (entry.x < minX) { minX = entry.x; }
                if (entry.y > maxY) { maxY = entry.y; }
                if (entry.y < minY) { minY = entry.y; }
            });
            const proxyPath = new Proxy(new THREE.Path(data[0].points));

            const geometry = new THREE.TubeBufferGeometry(proxyPath, data[0].points.length, options.radius,  options.showNodes ? 16 : 32, false);

            const material = new THREE.MeshLambertMaterial({
                color: 0x2962FF,
                wireframe: options.showNodes
            });

            const scene = new THREE.Scene();
            scene.add(new THREE.Mesh(geometry, material));
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            scene.add(new THREE.DirectionalLight(0xffffff, 1));

            const dotGeometry = options.showNodes ? new THREE.Geometry() : null;
            if (options.showNodes) {
                data[0].points.forEach(entry => {
                    dotGeometry.vertices.push(new THREE.Vector3(entry.x, entry.y, 0));
                });
                const dotMaterial = new THREE.PointsMaterial({ size: 2, sizeAttenuation: false, color: 0xffffff });
                scene.add(new THREE.Points(dotGeometry, dotMaterial));
            }

            const maxRange = Math.max(maxX - minX, maxY - minY);
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, maxRange / 4, 500);
            camera.position.set((minX + maxX) / 2, (minY + maxY) / 2, maxRange * 2);
            console.log('Camera @', (minX + maxX) / 2, (minY + maxY) / 2, maxRange * 2);
            camera.lookAt(new THREE.Vector3((minX + maxX) / 2, (minY + maxY) / 2, 0));

            const renderer = new THREE.WebGLRenderer({ canvas });
            renderer.render(scene, camera);

            let startTime = null;
            let fIndexHigh = 1;
            const animate = function (time) {
                const nextFrame = requestAnimationFrame(animate);
                if (!startTime) {
                    startTime = time;
                    return;
                }
                let secondsElapsed = (time - startTime) / 1000 * options.speed;
                while (data[fIndexHigh].time < secondsElapsed) {
                    if (fIndexHigh === data.length - 1) {
                        // final state reached
                        secondsElapsed = data[fIndexHigh].time;
                        cancelAnimationFrame(nextFrame);
                        break;
                    }
                    fIndexHigh++;
                }
                const fIndexLow = fIndexHigh - 1;
                const frameIndex = (secondsElapsed - data[fIndexLow].time) / (data[fIndexHigh].time - data[fIndexLow].time) + fIndexLow;
                const nodes = data[fIndexHigh].points.map((fhp, vindex) => {
                    return new THREE.Vector2(
                        fhp.x * (frameIndex - fIndexLow) + data[fIndexLow].points[vindex].x * (fIndexHigh - frameIndex),
                        fhp.y * (frameIndex - fIndexLow) + data[fIndexLow].points[vindex].y * (fIndexHigh - frameIndex)
                    );
                });
                proxyPath.path = new THREE.Path(nodes);
                if (options.showNodes) {
                    nodes.forEach((node, vindex) => {
                        dotGeometry.vertices[vindex].set(node.x, node.y, 0);
                    });
                    dotGeometry.verticesNeedUpdate = true;
                }
                geometry.copy(new THREE.TubeBufferGeometry(proxyPath, data[0].points.length, options.radius, options.showNodes ? 16 : 32, false));
                geometry.needUpdate = true;
                setTc(display, 'Animating: t = ' + secondsElapsed.toFixed(3));
                renderer.render(scene, camera);
            };

            requestAnimationFrame(animate);
        };

        document.getElementById('start').addEventListener('click', () => {
            const evtSource = new EventSource('/task');
            evtSource.onmessage = e => {
                console.log('R', e.data);
            };
            evtSource.onerror = () => {
                evtSource.close();
            };
        });

        fetch('/list').then(response => response.json()).then(json => {
            if (json.length) {
                let selected = null;
                const fl = document.getElementById('file-list');
                const btn = fl.nextElementSibling;
                setTc(fl.previousElementSibling, 'Select a previous result to load.');
                btn.classList.remove('disabled');
                json.forEach(entry => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.appendChild(document.createTextNode(entry));
                    li.addEventListener('click', () => {
                        if (selected) { selected.classList.remove('active'); }
                        selected = li;
                        li.classList.add('active');
                    });
                    fl.appendChild(li);
                });
                fl.style.display = 'block';
                btn.addEventListener('click', () => {
                    if (!selected) {
                        window.alert('Please select a file first!');
                    } else {
                        const options = animOptions();
                        const fileName = selected.firstChild.textContent;
                        fetch('data/' + fileName).then(response => response.json()).then(rows => {
                            const grouped = rows.map(({ time, data }) => {
                                let output = [];
                                for (let i = 0; i < data.length; i += 2) {
                                    output.push(new THREE.Vector2(data[i], data[i + 1] * options.exaggerateY));
                                }
                                return { points: output, time };
                            });
                            setTc(title, fileName);
                            render(grouped, options);
                        });
                    }
                });
            }
        });
    });
</script>
<body>
    <div class="fullpage">
        <nav class="navbar navbar-dark bg-primary">
            <span class="navbar-brand" id="title">MAE 259B / Group 2: DER</span>
            <span class="navbar-text" id="display">Stopped</span>
        </nav>
        <canvas id="canvas"></canvas>
        <div class="row px-5 py-5" id="welcome">
            <div class="col-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Start computation</h5>
                        <p class="card-text">Start a fresh computation using Newton-Raphson.</p>
                        <button class="btn btn-primary disabled" id="start">Please run manually</button>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Load a previous result</h5>
                        <p class="card-text">No saved result available.</p>
                        <ul class="list-group list-group-flush mb-4" id="file-list">
                        </ul>
                        <button class="btn btn-primary disabled">Go</button>
                    </div>
                </div>
            </div>
            <div class="col-12 mt-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Animation Options</h5>
                        <form>
                            <div class="form-group row">
                                <label for="animopt-exaggerate" class="col-2 col-form-label">Exaggerate Y</label>
                                <div class="col-8">
                                    <input type="range" class="form-control" id="animopt-exaggerate" min="0" max="1" step="0.001" value="0" />
                                </div>
                                <div class="col-2">1</div>
                            </div>
                            <div class="form-group row">
                                <label for="animopt-speed" class="col-2 col-form-label">Playback speed</label>
                                <div class="col-8">
                                    <input type="range" class="form-control" id="animopt-speed" min="-0.5" max="0.5" step="0.001" value="0" />
                                </div>
                                <div class="col-2">1</div>
                            </div>
                            <div class="form-group row align-items-center">
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="animopt-showpoints">
                                        <label class="form-check-label" for="animopt-showpoints">Show nodes</label>
                                    </div>
                                </div>
                                <label for="animopt-radius" class="col-2 col-form-label">Rod radius</label>
                                <div class="col-4">
                                    <input type="text" class="form-control" id="animopt-radius" value="5e-3" />
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>